name: Quality Gates

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["**"]

concurrency:
  group: quality-gates-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    if: ${{ github.event.repository.private == false }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: JavaScript/TypeScript checks
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t npm_dirs < <(find . -type f -name package.json -not -path '*/node_modules/*' -printf '%h\n' | sort -u)
          for dir in "${npm_dirs[@]}"; do
            echo "==> npm checks in $dir"
            pushd "$dir" >/dev/null
            if [ -f package-lock.json ]; then
              if ! npm ci --no-audit --no-fund; then
                echo "npm ci failed in $dir, falling back to npm install"
                npm install --no-audit --no-fund
              fi
            else
              npm install --no-audit --no-fund
            fi
            npm run lint --if-present
            test_script="$(python3 -c 'import json; d=json.load(open("package.json", encoding="utf-8")); print((d.get("scripts") or {}).get("test", ""))')"
            if [ -z "$test_script" ] || [ "$test_script" = "echo \"Error: no test specified\" && exit 1" ]; then
              echo "Skipping placeholder/missing npm test in $dir"
            else
              npm test
            fi
            npm run build --if-present
            popd >/dev/null
          done

      - name: Node plain TCP tests
        run: |
          set -euo pipefail
          node --test node-plain-tcp/test/*.test.js

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install Python system dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libmariadb-dev pkg-config

      - name: Python checks
        shell: bash
        run: |
          set -euo pipefail
          if [ -f python-client-server-with-database/server/requirements.txt ]; then
            python -m pip install --upgrade pip
            python -m pip install -r python-client-server-with-database/server/requirements.txt
            python -m compileall python-client-server-with-database/server
            cd python-client-server-with-database/server
            SKIP_DB_CHECK=1 python -m unittest discover -s tests -p 'test_*.py' -v
            cd -
          fi

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: stable

      - name: Go checks
        run: |
          set -euo pipefail
          cd golang-client-server-with-database/server
          go test ./...
          go build ./...

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust checks
        run: |
          set -euo pipefail
          cd rust-client-server-with-database/server
          cargo test --locked
          cargo build --locked

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "8.0.x"

      - name: C# checks
        run: |
          set -euo pipefail
          dotnet test csharp-client-server-with-database/tests/CsharpClientServerWithDatabase.Tests.csproj --configuration Release
          dotnet build csharp-client-server-with-database/server/CsharpClientServerWithDatabase.csproj --configuration Release

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"

      - name: Java checks
        shell: bash
        run: |
          set -euo pipefail
          MAVEN_VERSION=3.9.12
          curl -fsSL "https://downloads.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz" -o /tmp/maven.tar.gz || \
          curl -fsSL "https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz" -o /tmp/maven.tar.gz
          tar -xzf /tmp/maven.tar.gz -C /tmp
          MVN="/tmp/apache-maven-${MAVEN_VERSION}/bin/mvn"
          "$MVN" -f java-spring-client-server/pom.xml -B test
          "$MVN" -f java-spring-mqtt/pom.xml -B test
          "$MVN" -f java-spring-client-server-with-database/server/pom.xml -B test

      - name: PHP checks
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends php-cli php-xml php-mbstring
          # Install PHPUnit
          wget https://phar.phpunit.de/phpunit-10.5.12.phar -O /usr/local/bin/phpunit
          chmod +x /usr/local/bin/phpunit
          # Syntax check all PHP files
          find php-client-server php-client-server-with-database -type f -name '*.php' -print0 | xargs -0 -n1 php -l
          # Run smoke tests
          php php-client-server/tests/smoke_test.php
          php php-client-server-with-database/server/tests/smoke_test.php
          # Run PHPUnit tests
          cd php-client-server-with-database/server
          php ../../phpunit.phar tests/RouteTest.php

      - name: C/C++ checks
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends cmake pkg-config libmariadb-dev nlohmann-json3-dev
          BUILD_DIR=/tmp/quality-cpp-build
          rm -rf "$BUILD_DIR"
          cmake -S cplusplus-client-server-with-database/server -B "$BUILD_DIR" -DCMAKE_BUILD_TYPE=Release
          cmake --build "$BUILD_DIR" -j"$(nproc)"
          ctest --test-dir "$BUILD_DIR" --output-on-failure
